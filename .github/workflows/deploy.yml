name: Deploy to Production (Docker)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to VPS via Docker
        uses: appleboy/ssh-action@v1.0.3
        env:
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_URL_ADMIN: ${{ secrets.NEXTAUTH_URL_ADMIN }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          envs: NEXTAUTH_SECRET,NEXTAUTH_URL,NEXTAUTH_URL_ADMIN,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB
          script: |
            set -e
            PROJECT_DIR="/var/www/myinsurancebuddies.com"
            
            echo "ðŸš€ Deploying MyInsuranceBuddies..."
            
            # Create directory and clone if .git doesn't exist
            if [ ! -d "$PROJECT_DIR/.git" ]; then
              echo "ðŸ“ Setting up project directory..."
              rm -rf $PROJECT_DIR
              mkdir -p $PROJECT_DIR
              cd $PROJECT_DIR
              git clone https://github.com/ihetgoti/myinsurancebuddy.git .
            else
              cd $PROJECT_DIR
            fi
            
            # Pull latest code
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # Create/update .env file
            echo "ðŸ“ Creating .env file..."
            cat > .env << EOF
            # Database
            POSTGRES_USER=${POSTGRES_USER:-myuser}
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-mypassword}
            POSTGRES_DB=${POSTGRES_DB:-myinsurancebuddy}
            DATABASE_URL=postgresql://${POSTGRES_USER:-myuser}:${POSTGRES_PASSWORD:-mypassword}@localhost:5432/${POSTGRES_DB:-myinsurancebuddy}?schema=public
            
            # NextAuth
            NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
            NEXTAUTH_URL=${NEXTAUTH_URL:-https://myinsurancebuddies.com}
            NEXTAUTH_URL_ADMIN=${NEXTAUTH_URL_ADMIN:-https://admin.myinsurancebuddies.com}
            
            # Site
            SITE_URL=https://myinsurancebuddies.com
            NODE_ENV=production
            EOF
            
            # Install dependencies (needed for Prisma migrations)
            echo "ðŸ“¦ Installing dependencies..."
            pnpm install --frozen-lockfile
            
            # Generate Prisma client
            echo "ðŸ”§ Generating Prisma client..."
            cd packages/db
            npx prisma generate
            
            # Run migrations
            echo "ðŸ“‹ Running database migrations..."
            npx prisma migrate deploy || echo "âš ï¸ Migration completed with warnings"
            
            # Seed database
            echo "ðŸŒ± Seeding database..."
            npx ts-node --transpile-only prisma/seed.ts || echo "Seed skipped (may already exist)"
            cd ../..
            
            # Build apps (on VPS with DATABASE_URL available)
            echo "ðŸ—ï¸ Building applications..."
            pnpm build
            
            # Update nginx config
            echo "ðŸ”§ Configuring Nginx..."
            sudo cp nginx.conf /etc/nginx/sites-available/myinsurancebuddies.com
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo ln -sf /etc/nginx/sites-available/myinsurancebuddies.com /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx
            
            # Restart apps with PM2
            echo "ðŸ”„ Restarting PM2 services..."
            pm2 delete all || true
            pm2 start ecosystem.config.js
            pm2 save
            
            echo "âœ… Deployment completed successfully!"
